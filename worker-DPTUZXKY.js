var D={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:100};var L={MAX_DEPTH:5,MAX_BRANCHING:20,QUIESCENCE_DEPTH:4},R={pawn:0,knight:1,bishop:2,rook:3,queen:4,king:5},K={white:0,black:1},Y=[[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,25,25,10,5,5],[0,0,0,20,20,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-20,-20,10,10,5],[0,0,0,0,0,0,0,0]],$=[[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],Z=[[-20,-10,-10,-10,-10,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,10,10,5,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,10,10,10,10,0,-10],[-10,10,10,10,10,10,10,-10],[-10,5,0,0,0,0,5,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],j=[[0,0,0,0,0,0,0,0],[5,10,10,10,10,10,10,5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[-5,0,0,0,0,0,0,-5],[0,0,0,5,5,0,0,0]],J=[[-20,-10,-10,-5,-5,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,5,5,5,0,-10],[-5,0,5,5,5,5,0,-5],[0,0,5,5,5,5,0,-5],[-10,5,5,5,5,5,0,-10],[-10,0,5,0,0,0,0,-10],[-20,-10,-10,-5,-5,-10,-10,-20]],z=[[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-20,-30,-30,-40,-40,-30,-30,-20],[-10,-20,-20,-20,-20,-20,-20,-10],[20,20,0,0,0,0,20,20],[20,30,10,0,0,10,30,20]],W={pawn:Y,knight:$,bishop:Z,rook:j,queen:J,king:z},b={MATERIAL:1,POSITION:.01,DEVELOPMENT:.5,KING_SAFETY:1,PAWN_STRUCTURE:.5},P={DOUBLED_PAWN_PENALTY:.5,ISOLATED_PAWN_PENALTY:.5,CASTLING_BONUS:1,CENTER_KING_PENALTY:2,DEVELOPMENT_BONUS:.5};var S=8,V=97;function C(e){let o=e.charCodeAt(0)-V,r=Number(e.charAt(1))-1;return{row:S-1-r,col:o}}function U(e,o){let r=String.fromCharCode(V+o),t=S-e;return`${r}${t}`}function H(e,o){return e>=0&&e<S&&o>=0&&o<S}function E(e,o){let r=C(o);return H(r.row,r.col)?e[r.row][r.col].piece:null}function G(e,o,r,t,n){let s=t===o?0:t>o?1:-1,i=n===r?0:n>r?1:-1,c=o+s,u=r+i;for(;c!==t||u!==n;){if(e[c][u].piece)return!1;c+=s,u+=i}return!0}function F(e,o,r,t){let[n,s]=r,[i,c]=t;if(!H(i,c)||n===i&&s===c)return!1;let u=e[i][c].piece;return u&&u.color===o.color?!1:ee(e,o,[n,s],[i,c])}function ee(e,o,r,t){let[n,s]=r,[i,c]=t,u=Math.abs(i-n),a=Math.abs(c-s);switch(o.type){case"pawn":return oe(e,o,n,s,i,c);case"rook":return X(e,n,s,i,c);case"knight":return re(n,s,i,c);case"bishop":return Q(e,n,s,i,c);case"queen":return ne(e,n,s,i,c);case"king":return te(n,s,i,c);default:return!1}}function oe(e,o,r,t,n,s){let i=o.color==="white"?-1:1,c=o.color==="white"?S-2:1,u=n-r,a=s-t;return e[n][s].piece!==null?Math.abs(a)===1&&u===i:a===0&&u===i?!0:a===0&&u===2*i&&r===c?!e[r+i][t].piece:!1}function X(e,o,r,t,n){return o===t&&r!==n||r===n&&o!==t?G(e,o,r,t,n):!1}function re(e,o,r,t){let n=Math.abs(r-e),s=Math.abs(t-o);return n===2&&s===1||n===1&&s===2}function Q(e,o,r,t,n){let s=Math.abs(t-o),i=Math.abs(n-r);return s===i&&s>0?G(e,o,r,t,n):!1}function ne(e,o,r,t,n){return X(e,o,r,t,n)||Q(e,o,r,t,n)}function te(e,o,r,t){let n=Math.abs(r-e),s=Math.abs(t-o);return n<=1&&s<=1&&(n>0||s>0)}function se(e){return e.map(o=>o.map(r=>({...r,piece:r.piece?{...r.piece}:null})))}function I(e,o){let r=[];for(let t of e)for(let n of t)n.piece&&n.piece.color===o&&r.push(n.position);return r}function T(e){return D[e]||0}function h(e,o,r){let t=se(e),n=C(o),s=C(r),i=t[n.row][n.col],c=t[s.row][s.col];if(!i.piece)return t;let u=i.piece;return c.piece={...u,position:r,hasMoved:!0},i.piece=null,t}function B(e){let o=0,r=0,t=0,n=0,s=0;for(let i=0;i<8;i++)for(let c=0;c<8;c++){let u=e[i][c];if(!u.piece)continue;let a=u.piece,f=a.color==="white",p=f?-1:1;o+=T(a.type)*p*b.MATERIAL;let l=ie(a.type,i,c,f);r+=l*p*b.POSITION,t+=ce(a,i,c,f)*p*b.DEVELOPMENT,n+=ue(a,i,c,f)*p*b.KING_SAFETY,s+=ae(e,a,i,c,f)*p*b.PAWN_STRUCTURE}return o+r+t+n+s}function ie(e,o,r,t){let n=W[e];if(!n)return 0;let s=t?7-o:o;return n[s][r]}function ce(e,o,r,t){let n=0;return(e.type==="knight"||e.type==="bishop")&&(o===(t?7:0)?n-=P.DEVELOPMENT_BONUS:n+=P.DEVELOPMENT_BONUS),n}function ue(e,o,r,t){if(e.type!=="king")return 0;let n=0;return r>=3&&r<=4&&(n-=P.CENTER_KING_PENALTY),(r===6||r===2)&&(t&&o===7||!t&&o===0)&&(n+=P.CASTLING_BONUS),n}function ae(e,o,r,t,n){if(o.type!=="pawn")return 0;let s=0,i=0;for(let u=0;u<8;u++)u!==r&&e[u][t].piece?.type==="pawn"&&e[u][t].piece?.color===o.color&&i++;s-=i*P.DOUBLED_PAWN_PENALTY;let c=!0;for(let u=t-1;u<=t+1;u+=2)if(u>=0&&u<8){for(let a=0;a<8;a++)if(e[a][u].piece?.type==="pawn"&&e[a][u].piece?.color===o.color){c=!1;break}}return c&&(s-=P.ISOLATED_PAWN_PENALTY),s}var _={...L},d=0,k=25e3,A=[];function le(){for(let e=0;e<8;e++){A[e]=[];for(let o=0;o<8;o++){A[e][o]=[];for(let r=0;r<6;r++){A[e][o][r]=[];for(let t=0;t<2;t++)A[e][o][r][t]=Math.floor(Math.random()*2147483647)}}}}var fe=new Map,M=new Map;function pe(e){let o=0;for(let r=0;r<8;r++)for(let t=0;t<8;t++){let n=e[r][t];if(n.piece){let s=R[n.piece.type],i=K[n.piece.color];typeof s=="number"&&typeof i=="number"&&s>=0&&s<6&&i>=0&&i<2&&(o^=A[r][t][s][i])}}return o.toString(16)}function q(e,o){let r=E(e,o);if(!r)return[];let t=[],n=C(o);for(let s=0;s<8;s++)for(let i=0;i<8;i++){let c=U(s,i);c!==o&&F(e,r,[n.row,n.col],[s,i])&&t.push(c)}return t}function O(e,o){return e.sort((r,t)=>{let n=E(o,r.to),s=E(o,t.to),i=n?T(n.type):0;return(s?T(s.type):0)-i}).slice(0,_.MAX_BRANCHING)}function x(e,o,r,t,n){let s=B(e);if(n<=0)return s;if(t){if(s>=r)return r;o=Math.max(o,s)}else{if(s<=o)return o;r=Math.min(r,s)}let i=t?"black":"white",c=I(e,i),u=[];for(let f of c){let p=q(e,f);for(let l of p){let m=E(e,l);m&&m.color!==i&&u.push({from:f,to:l,score:0})}}let a=O(u,e);if(t){let f=s;for(let p of a){let l=h(e,p.from,p.to),m=x(l,o,r,!1,n-1);if(f=Math.max(f,m),o=Math.max(o,m),o>=r)break}return f}else{let f=s;for(let p of a){let l=h(e,p.from,p.to),m=x(l,o,r,!0,n-1);if(f=Math.min(f,m),r=Math.min(r,m),r<=o)break}return f}}function w(e,o,r,t,n){if(performance.now()-d>k)return n?-1/0:1/0;let i=`${pe(e)}|${o}|${n}`,c=M.get(i);if(c&&c.depth>=o)return c.score;if(o===0){let l=x(e,r,t,n,_.QUIESCENCE_DEPTH);return M.set(i,{score:l,depth:o}),l}let u=n?"black":"white",a=I(e,u),f=[];for(let l of a){let m=q(e,l);for(let g of m)f.push({from:l,to:g,score:0})}if(f.length===0){let l=B(e);return M.set(i,{score:l,depth:o}),l}let p=O(f,e);if(n){let l=-1/0;for(let m of p){let g=h(e,m.from,m.to),v=w(g,o-1,r,t,!1);if(l=Math.max(l,v),r=Math.max(r,v),r>=t)break}return M.set(i,{score:l,depth:o}),l}else{let l=1/0;for(let m of p){let g=h(e,m.from,m.to),v=w(g,o-1,r,t,!0);if(l=Math.min(l,v),t=Math.min(t,v),t<=r)break}return M.set(i,{score:l,depth:o}),l}}function me(e){d=performance.now();let o=I(e,"black"),r=[];for(let c of o){let u=q(e,c);for(let a of u)r.push({from:c,to:a,score:0})}if(r.length===0)return null;let t=_.MAX_DEPTH,n=null,s=-1/0,i=O(r,e);for(let c of i){if(performance.now()-d>k){console.warn("Timeout alcanzado, retornando mejor movimiento hasta ahora");break}let u=h(e,c.from,c.to),a=w(u,t-1,-1/0,1/0,!1);a>s&&(s=a,n={...c,score:a})}return n}function Pe(e,o){d=performance.now();let r=_.MAX_DEPTH,t=[];for(let n of o){if(performance.now()-d>k){console.warn("Timeout en evaluaci\xF3n de movimientos");break}let s=h(e,n.from,n.to),i=w(s,r-1,-1/0,1/0,!1);t.push({...n,score:i})}return t.sort((n,s)=>s.score-n.score)}function he(){fe.clear(),M.clear()}le();addEventListener("message",({data:e})=>{try{switch(e.type){case"findBestMove":if(!e.board){let i={type:"error",error:"Board is required for findBestMove",messageId:e.messageId};postMessage(i);return}let r={type:"bestMove",move:me(e.board),messageId:e.messageId};postMessage(r);break;case"evaluateMoves":if(!e.board||!e.moves){let i={type:"error",error:"Board and moves are required for evaluateMoves",messageId:e.messageId};postMessage(i);return}let n={type:"bestMoves",moves:Pe(e.board,e.moves),messageId:e.messageId};postMessage(n);break;case"clearCache":he();break;default:let s={type:"error",error:`Unknown message type: ${e.type}`,messageId:e.messageId};postMessage(s)}}catch(o){let r={type:"error",error:o instanceof Error?o.message:"Unknown error",messageId:e.messageId};postMessage(r)}});
